<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>An√°lise da Doen√ßa na Folha</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .container {
      background: white;
      max-width: 1000px;
      width: 100%;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    button, select {
      padding: 0.5em 1.5em;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover, select:hover {
      background: #218838;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2c7be5;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: girar 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes girar {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .container-imagens {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
      margin: 1rem 0;
    }

    .imagem-box {
      flex: 1;
      min-width: 280px;
      max-width: 300px;
      text-align: center;
    }

    img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      border: 1px solid #ddd;
      padding: 5px;
      background: #fff;
    }

    .botao-acao {
      display: inline-block;
      background-color: #2c7be5;
      color: white;
      text-align: center;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 6px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      margin-top: 0.8rem;
    }

    .botao-acao:hover {
      background-color: #1a5bb8;
    }

    .linha-botoes {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Escala Diagram√°tica para Doen√ßas de Plantas</h1>
    <form id="formulario">
      <input type="file" id="imagem" name="image" accept="image/*" multiple required>
      <select id="indice" name="indice">
        <option value="vari">VARI</option>
        <option value="gli">GLI</option>
        <option value="ngrdi">NGRDI</option>
      </select>
      <button type="submit" id="botao-analisar">Analisar</button>
    </form>

    <div id="carregando" style="display:none;">
      <div class="spinner"></div>
      <p style="font-weight: bold; color: #2c7be5;">Carregando an√°lise...</p>
    </div>

    <div id="resultados"></div>
  </div>

  <script>
    const form = document.getElementById("formulario");
    const resultadosDiv = document.getElementById("resultados");
    const carregandoDiv = document.getElementById("carregando");
    const botao = document.getElementById("botao-analisar");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultadosDiv.innerHTML = "";
      carregandoDiv.style.display = "block";
      botao.disabled = true;

      const formData = new FormData(form);
      const files = document.getElementById("imagem").files;

      for (let file of files) {
        const tempData = new FormData();
        tempData.append("image", file);
        tempData.append("indice", formData.get("indice"));
        const imagemOriginalURL = URL.createObjectURL(file);

        const response = await fetch("/analisar", { method: "POST", body: tempData });
        const result = await response.json();
        const data = Array.isArray(result) ? result[0] : result;

        const proc = `data:image/png;base64,${data.imagem}`;
        const ind = `data:image/png;base64,${data.imagem_indice}`;
        const indiceTexto = `√çndice ${formData.get("indice").toUpperCase()} - Min: ${data.indices_vegetacao[formData.get("indice")].min.toFixed(3)}, M√©dia: ${data.indices_vegetacao[formData.get("indice")].media.toFixed(3)}, M√°x: ${data.indices_vegetacao[formData.get("indice")].max.toFixed(3)}`;

        const container = document.createElement("div");
        const pct = data.area_total > 0 ? [
          ((data.area_saudavel / data.area_total) * 100).toFixed(1),
          ((data.area_doente / data.area_total) * 100).toFixed(1),
          ((data.area_morta / data.area_total) * 100).toFixed(1)
        ] : ['0.0', '0.0', '0.0'];

        container.innerHTML = `
          <h3>Resultado para ${file.name}</h3>
          <p><strong>Tecido Saud√°vel:</strong> ${pct[0]}% | <strong>Doente:</strong> ${pct[1]}% | <strong>Morto:</strong> ${pct[2]}%</p>
          <div class="container-imagens">
            <div class="imagem-box"><p>Original</p><img id="img-original" src="${imagemOriginalURL}"></div>
            <div class="imagem-box"><p>Processada</p><img id="img-processada" src="${proc}"></div>
            <div class="imagem-box"><p>√çndice</p><img id="img-indice" src="${ind}"></div>
          </div>
          <p>${indiceTexto}</p>
          <div class="linha-botoes">
            <button class="botao-acao" onclick="baixarTodas('${imagemOriginalURL}', '${proc}', '${ind}', '${file.name}')">‚¨áÔ∏è Baixar Todas as Imagens</button>
            <button class="botao-acao gerar-relatorio" data-nome="${file.name}" data-original="${imagemOriginalURL}" data-processada="${proc}" data-indice="${ind}" data-indiceinfo="${indiceTexto}" data-percentagens="${pct.join(',')}">üìÑ Gerar Relat√≥rio T√©cnico</button>
          </div>
        `;

        resultadosDiv.appendChild(container);
      }

      carregandoDiv.style.display = "none";
      botao.disabled = false;
    });

    function baixarTodas(original, processada, indice, nome) {
      const zip = new JSZip();
      zip.file(`${nome}_original.png`, urlToPromise(original), { binary: true });
      zip.file(`${nome}_processada.png`, urlToPromise(processada), { binary: true });
      zip.file(`${nome}_indice.png`, urlToPromise(indice), { binary: true });
      zip.generateAsync({ type: "blob" }).then(function(content) {
        saveAs(content, `imagens_${nome}.zip`);
      });
    }

    async function urlToPromise(url) {
      const res = await fetch(url);
      return await res.blob();
    }

    document.addEventListener('click', async function (e) {
      if (e.target.classList.contains("gerar-relatorio")) {
        const btn = e.target;
        btn.disabled = true;
        btn.innerText = "A gerar...";

        const nome = btn.dataset.nome;
        const original = btn.dataset.original;
        const proc = btn.dataset.processada;
        const ind = btn.dataset.indice;
        const indiceTexto = btn.dataset.indiceinfo;
        const [saudavel, doente, morto] = btn.dataset.percentagens.split(",");

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const agora = new Date();
        const dataHora = agora.toLocaleString('pt-PT');

        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(16);
        pdf.text("Relat√≥rio T√©cnico", 105, 20, { align: "center" });

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(12);
        pdf.text(`Desenvolvedor: Victor Ros√°rio de Novais`, 20, 35);
        pdf.text(`Data e Hora: ${dataHora}`, 20, 45);
        pdf.text(`Nome da Imagem: ${nome}`, 20, 55);
        pdf.text(`Tecido Saud√°vel: ${saudavel}% | Doente: ${doente}% | Morto: ${morto}%`, 20, 65);
        pdf.text(indiceTexto, 20, 75);

        const imgs = [original, proc, ind];
        const labels = ["Original", "Processada", "√çndice"];
        let y = 90;

        for (let i = 0; i < imgs.length; i++) {
          const img = await carregarImagemParaDataURL(imgs[i]);
          pdf.text(labels[i], 20, y);
          pdf.addImage(img, "PNG", 20, y + 5, 160, 80);
          y += 90;
        }

        pdf.save(`relatorio_tecnico_${nome}.pdf`);
        btn.disabled = false;
        btn.innerText = "üìÑ Gerar Relat√≥rio T√©cnico";
      }
    });

    function carregarImagemParaDataURL(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.src = src;
      });
    }
  </script>
  <!-- JSZip e FileSaver para compactar m√∫ltiplas imagens -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>

